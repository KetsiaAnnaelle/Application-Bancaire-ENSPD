<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinAIly - General Cameroun | Système Bancaire Intelligent</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- Charte Graphique SG Cameroun --- */
        :root {
            --primary: #E60028; /* Rouge SG */
            --primary-dark: #CC0023;
            --primary-light: #FFE6EA;
            --secondary: #000000; /* Noir */
            --secondary-light: #333333;
            --accent: #F5F5F5; /* Gris clair */
            --accent-dark: #E0E0E0;
            --accent-light: #FAFAFA;
            --warning: #FF9800;
            --danger: #E60028;
            --success: #00C853;
            --dark: #212121;
            --gray: #757575;
            --light-gray: #EEEEEE;
            --white: #FFFFFF;
            --shadow: 0 4px 20px rgba(230, 0, 40, 0.08);
            --shadow-hover: 0 8px 30px rgba(230, 0, 40, 0.15);
            --gradient-primary: linear-gradient(135deg, var(--primary), #FF3366);
            --gradient-dark: linear-gradient(135deg, var(--secondary), #333333);
            --gradient-accent: linear-gradient(135deg, var(--accent), #FFFFFF);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--accent-light) 0%, var(--white) 100%);
            color: var(--dark);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ===== GLOBAL COMPONENTS ===== */
        .btn {
            padding: 0.9rem 1.8rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 6px 20px rgba(230, 0, 40, 0.2);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(230, 0, 40, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-light);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background: var(--accent-dark);
            color: var(--dark);
        }

        .btn-accent:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--accent-dark);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 1.5rem;
            position: relative;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary);
            background: var(--primary-light);
            padding: 8px;
            border-radius: 8px;
        }

        .form-control {
            padding: 1rem 1.5rem;
            border: 2px solid var(--accent-dark);
            border-radius: 10px;
            font-size: 1rem;
            width: 100%;
            transition: all 0.3s ease;
            background: var(--white);
            color: var(--dark);
        }

        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            outline: none;
        }

        /* ===== PAGE DE CONNEXION (Point 1) ===== */
        .login-container {
            display: flex;
            height: auto;
            align-items: center;
            justify-content: center;
            background: var(--gradient-dark);
            position: relative;
            overflow: hidden;
        }

        .login-box {
            background: var(--white);
            border-radius: 20px;
            padding: 3rem;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .login-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
            border-radius: 20px 20px 0 0;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            margin: 0 auto 1rem;
            box-shadow: 0 8px 25px rgba(230, 0, 40, 0.3);
        }

        .login-logo-text {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--secondary);
            letter-spacing: -0.5px;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 2rem;
            background: var(--accent);
            border-radius: 12px;
            padding: 4px;
        }

        .login-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            text-align: center;
            background: none;
            border: none;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
        }

        .login-tab.active {
            color: var(--primary);
            background: var(--white);
            box-shadow: 0 4px 12px rgba(230, 0, 40, 0.1);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .access-message {
            background: #FFE6EA; /* primary-light */
            color: var(--primary);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }
        
        .login-btn {
            background: var(--gradient-primary);
            border: none;
            border-radius: 10px;
            padding: 1.1rem;
            width: 100%;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        /* ===== LAYOUT PRINCIPAL (Admin & Client) ===== */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--white);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.05);
            padding: 2rem 1.5rem;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid var(--accent-dark);
            display: flex;
            flex-direction: column;
        }
        
        .user-profile-card {
            background: var(--gradient-dark);
            border-radius: 16px;
            padding: 0.5rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            width: auto;
        }
        
        .user-profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border: 3px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .user-info h4 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
            letter-spacing: 0.3px;
        }
        
        .user-info p {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        
        .user-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem 1.2rem;
            border-radius: 10px;
            text-decoration: none;
            color: var(--gray);
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 6px 20px rgba(230, 0, 40, 0.2);
            transform: translateX(5px);
        }

        .nav-item i {
            font-size: 1.2rem;
            width: 24px;
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            background: var(--accent-light);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--accent-dark);
        }

        .content-header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .content-header-title i {
            color: var(--primary);
            background: var(--primary-light);
            padding: 10px;
            border-radius: 10px;
        }

        /* ===== LISTE DES CLIENTS (Point 2) ===== */
        .clients-search {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .search-container {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.1rem;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1.5rem 1rem 3.5rem;
            border: 2px solid var(--accent-dark);
            border-radius: 10px;
        }

        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .client-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            cursor: pointer;
            border: 1px solid var(--accent-dark);
        }

        .client-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(230, 0, 40, 0.1);
        }
        
        .client-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .client-info h4 {
            font-weight: 600;
            color: var(--secondary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-good { background: var(--success); color: white; }
        .status-warning { background: var(--warning); color: white; }
        .status-danger { background: var(--primary); color: white; }

        /* LISTE DES DEMANDES EN ATTENTE */
        .pending-list {
            list-style: none;
            padding: 0;
        }

        .pending-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--accent-dark);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pending-item:hover {
            background-color: var(--accent-light);
        }
        
        .pending-item-details strong {
            color: var(--primary);
        }

        .pending-item-tag {
            background: var(--primary-light);
            color: var(--primary);
            padding: 0.3rem 0.8rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        /* ===== PROFIL CLIENT (Point 3) ===== */
        .profile-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--accent);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            background: var(--gradient-dark);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 4px solid var(--white);
        }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        
        .info-section {
            background: var(--accent-light);
            border-radius: 14px;
            padding: 1.5rem;
            border: 1px solid var(--accent-dark);
        }

        .info-label {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .info-value {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 1rem;
            word-break: break-all;
        }

        .info-value.highlight {
            color: var(--primary);
        }

        /* ===== ANALYSE CRÉDIT (Point 4) ===== */
        #recommendationsList li {
            font-size: 1rem;
            margin-bottom: 10px;
            list-style: none;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        #recommendationsList li i {
            margin-top: 5px;
        }

        /* ===== CHATBOT (Point 5) (Reste inchangé) ===== */
        .chatbot-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .chatbot-button {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(230, 0, 40, 0.3);
        }

        .chatbot-window {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 350px;
            height: 450px;
            background: var(--white);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--accent-light);
        }
        
        .chat-input {
            padding: 1rem;
            border-top: 1px solid var(--accent-dark);
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            border: 1px solid var(--accent-dark);
            border-radius: 8px;
            padding: 10px;
        }

        .chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
        }
        
        /* Message style */
        .message-user {
            background: var(--primary-light);
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: right;
            border: 1px solid var(--primary);
            margin-left: auto;
            max-width: 80%;
        }
        
        .message-bot {
            background: #E0E0E0; /* Gris */
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: left;
            margin-right: auto;
            max-width: 80%;
        }

        /* ===== GRAPHIQUES (Point 7) (Reste inchangé) ===== */
        .chart-container {
            position: relative;
            height: 400px; /* Hauteur fixe pour le graphique */
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>

<div class="login-container" id="loginPage">
    <div class="login-box my-2">
        <div class="login-logo">
            <div class="login-logo-icon">
                <i class="fas fa-shield-alt"></i>
            </div>
            <div class="login-logo-text">FinAIly GC</div>
            <div class="login-subtitle">General Cameroun • Système Bancaire Intelligent</div>
        </div>
        
        <div class="login-tabs">
            <button class="login-tab active" onclick="showLoginForm('client')">
                <i class="fas fa-user me-2"></i>Espace Client
            </button>
            <button class="login-tab" onclick="showLoginForm('admin')">
                <i class="fas fa-user-shield me-2"></i>Espace Admin
            </button>
        </div>

        <form class="login-form active" id="clientLoginForm" onsubmit="event.preventDefault(); loginAsClient();">
            <div class="form-group">
                <label class="form-label"> <i class="fas fa-envelope"></i> E-mail du Client </label>
                <input type="email" class="form-control" placeholder="didier.fouda@example.com" required>
            </div>
            <div class="form-group">
                <label class="form-label"> <i class="fas fa-lock"></i> Mot de passe </label>
                <input type="password" class="form-control" placeholder="••••••••" required>
            </div>
            <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt me-2"></i>Se Connecter
            </button>
        </form>
        
        <form class="login-form" id="adminLoginForm" onsubmit="event.preventDefault(); loginAsAdmin();">
            <p class="access-message">Accès réservé au personnel autorisé.</p> 
            <div class="form-group">
                <label class="form-label"> <i class="fas fa-envelope"></i> E-mail de l'Administrateur </label>
                <input type="email" class="form-control" placeholder="admin1@bankapp.com" required>
            </div>
            <div class="form-group">
                <label class="form-label"> <i class="fas fa-lock"></i> Mot de passe </label>
                <input type="password" class="form-control" placeholder="••••••••" required>
            </div>
            <button type="submit" class="login-btn">
                <i class="fas fa-sign-in-alt me-2"></i>Connexion
            </button>
        </form>
    </div>
</div>

<div class="app-container" id="adminInterface">
    <aside class="sidebar" id="adminSidebar">
        <div class="user-profile-card">
            <div class="user-avatar">AD</div>
            <div class="user-info">
                <h4>Administrateur GC</h4>
                <p>admin@generalcameroun.cm</p>
                <div class="user-status">
                    <i class="fas fa-circle" style="font-size: 0.7rem; color: #FF9800;"></i> Personnel autorisé
                </div>
            </div>
        </div>
        
        <nav class="nav-menu">
            <a class="nav-item active" onclick="showPage('clientsList')">
                <i class="fas fa-users"></i> Liste Clients 
            </a>
            <a class="nav-item" onclick="showPage('clientProfile')">
                <i class="fas fa-user-tie"></i> Profil Client
            </a>
            <a class="nav-item" onclick="showPage('creditPrediction')">
                <i class="fas fa-chart-line"></i> Analyse Crédit (Prédiction)
            </a>
            <a class="nav-item" onclick="showPage('dashboard')">
                <i class="fas fa-chart-pie"></i> Dashboard Client
            </a>
            <a class="nav-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </a>
        </nav>
    </aside>

    <main class="main-content">
        
        <div class="page active" id="clientsList">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-users"></i> Gestion des Clients
                </div>
            </div>
            
            <div class="clients-search">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" placeholder="Rechercher un client par nom, email, numéro de compte..." onkeyup="searchClients(this.value)">
                </div>
            </div>

            <div class="clients-grid" id="clientsGrid">
                </div>
        </div>
        
        <div class="page" id="clientProfile">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-user-tie"></i> Détails du Client
                </div>
                <div class="header-actions">
                     <button class="btn btn-secondary" onclick="showPage('clientsList')"> 
                        <i class="fas fa-arrow-left me-2"></i>Retour à la liste 
                    </button>
                    <button class="btn btn-primary" onclick="editClient()">
                        <i class="fas fa-edit me-2"></i>Modifier (Simulé)
                    </button>
                </div>
            </div>
            
            <div class="profile-container card">
                <div class="profile-header">
                    <div class="profile-avatar" id="profileAvatar">MA</div>
                    <div class="profile-info">
                        <h1 id="profileName">Didier Fouda</h1>
                        <p id="profileProfession"><i class="fas fa-briefcase"></i> Entrepreneur</p>
                        <p id="profileStatus"><i class="fas fa-check-circle" style="color: var(--success);"></i> Statut : <span class="status-good status-badge">Premium</span></p>
                    </div>
                </div>
                
                <div class="profile-grid">
                    <div class="info-section">
                        <h3><i class="fas fa-user"></i> Informations Personnelles</h3>
                        <div class="info-group">
                            <div class="info-label">Date de Naissance</div>
                            <div class="info-value" id="clientBirthdate">1993-10-08</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Téléphone</div>
                            <div class="info-value" id="clientPhone">650112233</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Adresse</div>
                            <div class="info-value" id="clientAddress">Yaoundé, Essos</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">E-mail</div>
                            <div class="info-value highlight" id="clientEmail">didier.fouda@example.com</div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3><i class="fas fa-university"></i> Informations Bancaires</h3>
                        <div class="info-group">
                            <div class="info-label">Numéro de Compte</div>
                            <div class="info-value highlight" id="clientAccount">ACC00441122</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">IBAN</div>
                            <div class="info-value" id="clientIBAN">CM79 0050 1000 1122 3344 5566 778</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">RIB</div>
                            <div class="info-value" id="clientRIB">10005 00003 11223344556 89</div>
                        </div>
                        <div class="info-group">
                            <div class="info-label">Numéro de Carte / Expiration</div>
                            <div class="info-value" id="clientCard">**** **** **** 1122 / 03/29</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons mt-4">
                    <button class="btn btn-primary" onclick="showPage('dashboard')">
                        <i class="fas fa-chart-bar me-2"></i>Voir Dashboard Client
                    </button>
                    <button class="btn btn-secondary" onclick="showPage('creditPrediction')">
                        <i class="fas fa-chart-line me-2"></i>Analyser Crédit
                    </button>
                </div>
            </div>
        </div>
        
        <div class="page" id="creditPrediction">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-chart-line"></i> Analyse et Simulation de Crédit IA
                </div>
            </div>
            
            <div class="card bg-primary-light border-0">
                 <div class="card-header bg-white border-0 p-3 mb-3" style="border-radius: 12px;">
                    <h3 class="card-title"><i class="fas fa-inbox"></i> Demandes de Crédit en Attente 
                        <span class="badge bg-danger" id="pendingRequestCount">0</span>
                    </h3>
                </div>
                <ul class="pending-list" id="pendingRequestsList">
                    </ul>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-bullseye"></i> Éligibilité Actuelle du Client: <span id="analyzedClientName">Non sélectionné</span></h3>
                </div>
                <p id="eligibilityStatus">Veuillez sélectionner un client dans la liste pour commencer l'analyse.</p>
                <div id="eligibilityDetails" class="alert alert-info" style="display: none; margin-top: 1rem;"></div>
            </div>

            <div id="recommendationsSection" class="card" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-lightbulb"></i> Prédiction et Recommandations (Comment améliorer sa situation)</h3>
                </div>
                
                <div class="mb-3">
                    <h4 style="font-size: 1.1rem; color: var(--primary);">Simulation pour l'obtention d'un crédit</h4>
                </div>
                
                <ul id="recommendationsList" style="padding-left: 20px;">
                    </ul>
                
                <div class="mt-4 d-flex justify-content-end gap-3">
                    <button class="btn btn-success" onclick="updateCreditRequestStatus('approved')">
                        <i class="fas fa-check-circle me-2"></i>Approuver
                    </button>
                    <button class="btn btn-danger" onclick="updateCreditRequestStatus('rejected')">
                        <i class="fas fa-times-circle me-2"></i>Rejeter
                    </button>
                    <button class="btn btn-accent" onclick="analyzeCreditEligibility()">
                        <i class="fas fa-redo-alt me-2"></i>Relancer l'Analyse
                    </button>
                </div>
            </div>
        </div>

        <div class="page" id="dashboard">
             <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-chart-bar"></i> Dashboard Client: <span id="dashboardClientName"></span>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="showPage('clientProfile')">
                        <i class="fas fa-arrow-left me-2"></i>Retour au Profil
                    </button>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-money-bill-wave"></i> Solde des Comptes</h3>
                        </div>
                        <canvas id="adminClientBalanceChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Distribution des Dépenses (Annuelle)</h3>
                        </div>
                        <canvas id="adminClientExpenseChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card">
                 <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-file-invoice"></i> Score de Crédit et Revenus</h3>
                </div>
                <div class="row">
                     <div class="col-md-6">
                        <div class="p-3">
                            <p class="mb-1" style="color: var(--gray);">Score de Crédit (sur 10)</p>
                            <h2 style="font-size: 3rem; color: var(--success); font-weight: 800;" id="dashboardCreditScore">9.0</h2>
                            <p class="text-success">Excellent. Risque de défaut très faible.</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3">
                            <p class="mb-1" style="color: var(--gray);">Revenu Mensuel (Simulé pour analyse)</p>
                            <h2 style="font-size: 3rem; color: var(--secondary); font-weight: 800;" id="dashboardMonthlyIncome">2.5M FCFA</h2>
                            <p>Capacité d'emprunt élevée.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
</div>

<div class="app-container" id="clientInterface">
     <aside class="sidebar" id="clientSidebar">
        <div class="user-profile-card">
            <div class="user-avatar" id="clientSidebarAvatar">DF</div>
            <div class="user-info">
                <h4 id="clientSidebarName">Didier Fouda</h4>
                <p id="clientSidebarEmail">didier.fouda@example.com</p>
                <div class="user-status">
                    <i class="fas fa-circle" style="font-size: 0.7rem; color: #00C853;"></i> Compte Actif 
                </div>
            </div>
        </div>
        
        <nav class="nav-menu">
            <a class="nav-item active" onclick="showClientPage('clientDashboard')">
                <i class="fas fa-home"></i> Tableau de Bord
            </a>
            <a class="nav-item" onclick="showClientPage('clientProfileView')">
                <i class="fas fa-user-circle"></i> Mon Profil
            </a>
            <a class="nav-item" onclick="showClientPage('clientCreditRequest')">
                <i class="fas fa-hand-holding-usd"></i> Demande de Crédit
            </a>
            <a class="nav-item" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </a>
        </nav>
        <div style="margin-top: auto; padding-top: 2rem; text-align: center;">
            <p style="font-size: 0.8rem; color: var(--gray);">Besoin d'aide ?</p>
            <button class="btn btn-primary btn-sm" onclick="toggleChatbot()">
                <i class="fas fa-comments me-2"></i>Chatter avec l'IA
            </button>
        </div>
    </aside>

    <main class="main-content">
        
        <div class="page active" id="clientDashboard">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-home"></i> Tableau de Bord Personnel
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card text-center" style="border-left: 5px solid var(--primary);">
                        <p class="text-muted mb-1">Solde Principal (DB: solde_initial)</p>
                        <h1 style="font-size: 2.5rem; color: var(--secondary); font-weight: 700;" id="clientDashboardMainBalance">3 500 000 FCFA</h1> 
                        <p class="text-success"><i class="fas fa-arrow-up"></i> +1.2% ce mois</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card text-center" style="border-left: 5px solid var(--success);">
                        <p class="text-muted mb-1">Épargne Objectif</p>
                        <h1 style="font-size: 2.5rem; color: var(--secondary); font-weight: 700;">850 000 FCFA</h1>
                        <p class="text-info"><i class="fas fa-check-circle"></i> 60% de l'objectif atteint</p>
                    </div>
                </div>
            </div>
            
            <section id="monthly-comparison" class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-bar"></i> Comparaison Mensuelle des Dépenses</h3>
                </div>
                <div class="chart-container">
                    <canvas id="clientComparisonChart"></canvas>
                </div>
                <small class="text-muted mt-3 d-block">Source: Analyse des transactions de votre compte courant.</small>
            </section>
            
            <section id="category-averages" class="card">
                <div class="card-header">
                    <h3 class="card-title"><i class="fas fa-chart-pie"></i> Moyennes par Catégorie</h3>
                </div>
                <div class="chart-container">
                    <canvas id="categoryAveragesChart"></canvas>
                </div>
                <small class="text-muted mt-3 d-block">Moyenne des montants par catégorie de transaction.</small>
            </section>
        </div>
        
        <div class="page" id="clientProfileView">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-user-circle"></i> Mon Profil
                </div>
            </div>
            <div class="alert alert-info">Cette vue est en lecture seule pour le client.</div>
            </div>
        
        <div class="page" id="clientCreditRequest">
            <div class="content-header">
                <div class="content-header-title">
                    <i class="fas fa-hand-holding-usd"></i> Soumettre une Demande de Crédit
                </div>
            </div>
            
            <div class="card bg-primary-light">
                <div class="card-header bg-white" style="border-radius: 12px 12px 0 0;">
                    <h3 class="card-title"><i class="fas fa-paper-plane"></i> Formulaire de Demande</h3>
                </div>
                <form id="creditRequestForm" class="p-4">
                    <p class="mb-4 text-muted">Veuillez remplir les détails de votre demande. Notre équipe d'analyse crédit procédera à l'étude de votre dossier.</p>
                    
                    <div class="mb-4">
                        <label class="form-label">Montant du Crédit Sollicité (FCFA)</label>
                        <input type="number" class="form-control" id="loanAmount" placeholder="Ex: 5 000 000" required>
                    </div>
                    <div class="mb-4">
                         <label class="form-label">Durée Souhaitée (Mois)</label>
                        <input type="number" class="form-control" id="loanDuration" placeholder="Ex: 60 mois" required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">But du Crédit</label>
                        <select class="form-control" id="loanPurpose" required>
                            <option value="">Sélectionner un motif</option>
                            <option>Achat immobilier</option>
                            <option>Achat véhicule</option>
                            <option>Crédit à la consommation</option>
                            <option>Financement études</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-primary w-100" onclick="submitCreditRequest(event)">
                        <i class="fas fa-check-circle me-2"></i>Soumettre la Demande
                    </button>
                </form>
            </div>
        </div>
        
    </main>
</div>

<div class="chatbot-container" id="chatbotContainer" style="display:none;">
    <button class="chatbot-button" onclick="toggleChatbot()">
        <i class="fas fa-times" id="chatbotIcon"></i>
    </button>
    <div class="chatbot-window" id="chatbotWindow">
        <div class="chat-header">
            Assistant GC
            <i class="fas fa-robot"></i>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message-bot">
                <small>Bonjour ! Je suis l'Assistant Virtuel de General Cameroun. Comment puis-je vous aider aujourd'hui ?</small>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatbotInput" placeholder="Tapez votre message ici...">
            <button onclick="sendChatbotMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // ========== DONNÉES DE SIMULATION (Base de Données Similée mise à jour avec la DB fournie) ==========
    let clientsData = [];

    let currentUser = null;
    let currentClient = null; // Client sélectionné côté admin
    let chartInstances = {};
    let creditRequestData = { amount: null, duration: null, purpose: null };
    
    // Demandes de crédit (chargées depuis le backend)
    let pendingCreditRequests = [];
    let currentRequestId = null;

    // Historique du chatbot (persisté dans localStorage)
    let chatHistory = [];

    // ========== UI UPDATE FUNCTIONS ==========
    function updateClientUI() {
        if (!currentUser) return;
        
        document.getElementById('clientSidebarName').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        document.getElementById('clientSidebarEmail').textContent = currentUser.email;
        document.getElementById('clientSidebarAvatar').textContent = currentUser.avatar;
        document.getElementById('clientDashboardMainBalance').textContent = formatFCFA(currentUser.balance || 0);
    }

    function updateAdminUI() {
        if (!currentUser) return;
        
        const adminSidebar = document.getElementById('adminSidebar');
        const userCard = adminSidebar.querySelector('.user-profile-card');
        if (userCard) {
            const nameEl = userCard.querySelector('h4');
            const emailEl = userCard.querySelector('p');
            if (nameEl) nameEl.textContent = currentUser.name || 'Administrateur GC';
            if (emailEl) emailEl.textContent = currentUser.email || 'admin@generalcameroun.cm';
        }
    }

    async function loadCurrentUser() {
        try {
            const response = await fetch('/api/auth/current-user');
            if (response.ok) {
                const data = await response.json();
                if (data.userType === 'client') {
                    currentUser = data.user;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('clientInterface').classList.add('active');
                    document.getElementById('chatbotContainer').style.display = 'block';
                    updateClientUI();
                } else {
                    currentUser = { ...data.user, type: 'admin' };
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('adminInterface').classList.add('active');
                    updateAdminUI();
                    fetchAdminClients();
                }
            }
        } catch (error) {
            console.error('Error loading current user:', error);
        }
    }

    // ========== UTILITIES ==========
    // Centralized SweetAlert helpers
    function showErrorAlert(title, text) {
        Swal.fire({
            icon: 'error',
            title: title || 'Erreur',
            text: text || '',
            confirmButtonText: 'OK'
        });
    }

    function showSuccessAlert(title, text) {
        Swal.fire({
            icon: 'success',
            title: title || 'Succès',
            text: text || '',
            timer: 2500,
            showConfirmButton: false
        });
    }

    function showInfoAlert(title, text) {
        Swal.fire({
            icon: 'info',
            title: title || 'Information',
            text: text || '',
            confirmButtonText: 'OK'
        });
    }

    async function showConfirmAlert(title, text, confirmButtonText = 'Oui', cancelButtonText = 'Annuler') {
        const result = await Swal.fire({
            icon: 'question',
            title: title || 'Confirmation',
            text: text || '',
            showCancelButton: true,
            confirmButtonText,
            cancelButtonText
        });
        return result.isConfirmed;
    }

    // ====== Gestion de l'historique du chatbot (localStorage) ======
    function saveChatHistory() {
        try {
            localStorage.setItem('finailyChatHistory', JSON.stringify(chatHistory));
        } catch (e) {
            console.error('Erreur sauvegarde historique chatbot:', e);
        }
    }

    function renderChatHistory() {
        const messages = document.getElementById('chatMessages');
        if (!messages) return;
        messages.innerHTML = '';

        // Si aucun historique, ajouter le message de bienvenue par défaut
        if (!chatHistory || chatHistory.length === 0) {
            chatHistory = [{
                type: 'bot',
                text: "Bonjour ! Je suis l'Assistant Virtuel de General Cameroun. Comment puis-je vous aider aujourd'hui ?"
            }];
            saveChatHistory();
        }

        chatHistory.forEach(msg => {
            const div = document.createElement('div');
            div.className = msg.type === 'user' ? 'message-user' : 'message-bot';
            const label = msg.type === 'user' ? 'Vous' : 'Assistant GC';
            div.innerHTML = `<small><strong>${label}:</strong> ${msg.text}</small>`;
            messages.appendChild(div);
        });

        messages.scrollTop = messages.scrollHeight;
    }

    function loadChatHistory() {
        try {
            const raw = localStorage.getItem('finailyChatHistory');
            chatHistory = raw ? JSON.parse(raw) || [] : [];
        } catch (e) {
            console.error('Erreur chargement historique chatbot:', e);
            chatHistory = [];
        }
        renderChatHistory();
    }

    function formatFCFA(amount) {
        const formatter = new Intl.NumberFormat('fr-FR', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        
        if (amount >= 1000000) {
             return (amount / 1000000).toFixed(1) + 'M FCFA';
        } else if (amount >= 1000) {
            return (amount / 1000).toFixed(0) + 'K FCFA';
        }
        return formatter.format(amount) + ' FCFA';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('fr-FR');
    }

    // ========== LOGIN/LOGOUT ==========
    function showLoginForm(type) {
        document.querySelectorAll('.login-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.login-form').forEach(form => form.classList.remove('active'));
        
        if (type === 'client') {
            document.querySelector('.login-tab:nth-child(1)').classList.add('active');
            document.getElementById('clientLoginForm').classList.add('active');
            document.querySelector('#adminLoginForm .access-message').style.display = 'none';
        } else {
            document.querySelector('.login-tab:nth-child(2)').classList.add('active');
            document.getElementById('adminLoginForm').classList.add('active');
            document.querySelector('#adminLoginForm .access-message').style.display = 'block';
        }
    }

    async function loginAsClient() {
        const form = document.getElementById('clientLoginForm');
        const emailInput = form.querySelector('input[type="email"]');
        const passwordInput = form.querySelector('input[type="password"]');
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
            showErrorAlert('Champs requis', 'Veuillez renseigner votre e-mail et votre mot de passe.');
            return;
        }

        // Validation simple d'e-mail côté client
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showErrorAlert('E-mail invalide', "Veuillez saisir une adresse e-mail valide.");
            return;
        }

        try {
            const response = await fetch('/api/auth/login/client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!response.ok) {
                showErrorAlert('Connexion échouée', data.error || 'Erreur de connexion.');
                return;
            }

            currentUser = data.user;
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('clientInterface').classList.add('active');
            document.getElementById('chatbotContainer').style.display = 'block';
            updateClientUI();
            showClientPage('clientDashboard');
            setTimeout(() => { 
                initClientChart(); 
                initCategoryAveragesChart();
            }, 300);
        } catch (error) {
            console.error('Login error:', error);
            showErrorAlert('Erreur', 'Erreur de connexion. Veuillez réessayer.');
        }
    }

    async function loginAsAdmin() {
        const form = document.getElementById('adminLoginForm');
        const emailInput = form.querySelector('input[type="email"]');
        const passwordInput = form.querySelector('input[type="password"]');
        
        const email = emailInput.value.trim();
        const password = passwordInput.value;

        if (!email || !password) {
            showErrorAlert('Champs requis', 'Veuillez renseigner votre e-mail et votre mot de passe.');
            return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showErrorAlert('E-mail invalide', "Veuillez saisir une adresse e-mail valide.");
            return;
        }

        try {
            const response = await fetch('/api/auth/login/admin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password })
            });

            const data = await response.json();

            if (!response.ok) {
                showErrorAlert('Connexion échouée', data.error || 'Erreur de connexion.');
                return;
            }

            currentUser = { ...data.user, type: 'admin' };
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('adminInterface').classList.add('active');
            
            updateAdminUI();
            showPage('clientsList');
            await fetchAdminClients();
            await loadPendingRequests();
        } catch (error) {
            console.error('Login error:', error);
            showErrorAlert('Erreur', 'Erreur de connexion. Veuillez réessayer.');
        }
    }
    
    async function logout() {
        const confirmed = await showConfirmAlert(
            'Déconnexion',
            'Êtes-vous sûr de vouloir vous déconnecter ?',
            'Se déconnecter',
            'Annuler'
        );
        if (!confirmed) {
            return;
        }

        try {
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
        } catch (error) {
            console.error('Logout error:', error);
        }
        
        currentUser = null;
        currentClient = null;
        document.getElementById('adminInterface').classList.remove('active');
        document.getElementById('clientInterface').classList.remove('active');
        document.getElementById('loginPage').style.display = 'flex';
        document.getElementById('chatbotContainer').style.display = 'none';
        // Réinitialiser l'historique du chatbot à la déconnexion
        chatHistory = [];
        try {
            localStorage.removeItem('finailyChatHistory');
        } catch (e) {
            console.error('Erreur nettoyage historique chatbot:', e);
        }
        showLoginForm('client');
        Object.values(chartInstances).forEach(chart => { if (chart) chart.destroy(); });
        chartInstances = {};
    }

    // ========== FONCTIONS ADMIN ==========
    async function fetchAdminClients() {
        try {
            const response = await fetch('/api/admin/clients');
            const data = await response.json();

            if (!response.ok) {
                console.error('Erreur chargement clients admin:', data.error || data);
                return;
            }

            clientsData = data.clients || [];
            if (!currentClient && clientsData.length > 0) {
                currentClient = clientsData[0];
            }
            loadClientsList(clientsData);
        } catch (error) {
            console.error('Erreur réseau chargement clients admin:', error);
        }
    }

    function showPage(pageId) {
        document.querySelectorAll('#adminInterface .page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        
        document.querySelectorAll('#adminSidebar .nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`#adminSidebar a[onclick="showPage('${pageId}')"]`).classList.add('active');
        
        if (pageId === 'dashboard' || pageId === 'creditPrediction' || pageId === 'clientProfile') {
            if (!currentClient) {
                showInfoAlert(
                    'Client non sélectionné',
                    "Veuillez d'abord sélectionner un client dans la 'Liste Clients'."
                );
                showPage('clientsList');
                return;
            }
        }
        
        if (pageId === 'dashboard') {
            document.getElementById('dashboardClientName').textContent = `${currentClient.firstName} ${currentClient.lastName}`;
            document.getElementById('dashboardCreditScore').textContent = `${currentClient.creditScore}/10`;
            document.getElementById('dashboardMonthlyIncome').textContent = formatFCFA(currentClient.monthlyIncome);
            initAdminChart();
        }
        
        if (pageId === 'creditPrediction') {
            // Charger les demandes (historique + en attente) pour le client courant si présent
            loadPendingRequests(currentClient ? currentClient.id : null);
            // Lancer l'analyse pour le client sélectionné par défaut
            if (currentClient) {
                document.getElementById('analyzedClientName').textContent = `${currentClient.firstName} ${currentClient.lastName}`;
                analyzeCreditEligibility();
            } else {
                document.getElementById('analyzedClientName').textContent = `Non sélectionné`;
                document.getElementById('eligibilityStatus').innerHTML = "Veuillez sélectionner un client pour commencer l'analyse.";
                document.getElementById('eligibilityDetails').style.display = 'none';
                document.getElementById('recommendationsSection').style.display = 'none';
            }
        }
    }
    
    // Fonction pour charger les cartes clients (Point 2 - utilise la DB)
    function loadClientsList(clients = clientsData) {
        const clientsGrid = document.getElementById('clientsGrid');
        clientsGrid.innerHTML = '';
        
        clients.forEach(client => {
            const statusClass = client.status === 'premium' ? 'status-good' : client.status === 'warning' ? 'status-warning' : 'status-danger';
            const statusText = client.statusText;
            
            const clientCard = document.createElement('div');
            clientCard.className = 'client-card';
            clientCard.onclick = () => viewClientProfile(client.id);
            
            clientCard.innerHTML = `
                <div class="client-header">
                    <div class="client-avatar" style="background: ${client.status === 'danger' ? 'var(--primary-dark)' : 'var(--secondary)'};">${client.avatar}</div>
                    <div class="client-info">
                        <h4>${client.firstName} ${client.lastName}</h4>
                        <p style="font-size:0.9rem; color:var(--gray); margin-bottom: 0.2rem;"><i class="fas fa-envelope" style="color:var(--primary);"></i> ${client.email}</p>
                        <p style="font-size:0.9rem; color:var(--gray); margin-bottom: 0;"><i class="fas fa-id-card" style="color:var(--primary);"></i> N° Compte: ${client.accountNumber}</p>
                    </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--accent);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="status-badge ${statusClass}"> ${statusText} </span>
                        <small style="font-weight: 600; color: var(--secondary);">Solde: ${formatFCFA(client.currentBalance)}</small>
                    </div>
                </div>
            `;
            clientsGrid.appendChild(clientCard);
        });
    }

    function searchClients(query) {
        if (!query.trim()) {
            loadClientsList(clientsData);
            return;
        }
        const filteredClients = clientsData.filter(client => 
            client.firstName.toLowerCase().includes(query.toLowerCase()) || 
            client.lastName.toLowerCase().includes(query.toLowerCase()) || 
            client.email.toLowerCase().includes(query.toLowerCase()) || 
            client.accountNumber.includes(query)
        );
        loadClientsList(filteredClients);
    }
    
    function viewClientProfile(clientId) {
        currentClient = clientsData.find(c => c.id === clientId);
        if (!currentClient) return;

        // Remplir les informations du profil avec les données de la DB (Point 3)
        document.getElementById('profileAvatar').textContent = currentClient.avatar;
        document.getElementById('profileName').textContent = `${currentClient.firstName} ${currentClient.lastName}`;
        document.getElementById('profileProfession').innerHTML = `<i class="fas fa-briefcase"></i> ${currentClient.profession}`;
        
        const statusClass = currentClient.status === 'premium' ? 'status-good' : currentClient.status === 'warning' ? 'status-warning' : 'status-danger';
        document.querySelector('#profileStatus .status-badge').className = `status-good status-badge ${statusClass}`;
        document.querySelector('#profileStatus .status-badge').textContent = currentClient.statusText;

        document.getElementById('clientBirthdate').textContent = currentClient.birthdate;
        document.getElementById('clientPhone').textContent = currentClient.phone;
        document.getElementById('clientAddress').textContent = currentClient.address;
        document.getElementById('clientEmail').textContent = currentClient.email;
        document.getElementById('clientAccount').textContent = currentClient.accountNumber;
        document.getElementById('clientIBAN').textContent = currentClient.iban;
        document.getElementById('clientRIB').textContent = currentClient.rib;
        // Affiche seulement les 4 derniers chiffres du numéro de carte (sécurité)
        document.getElementById('clientCard').textContent = `**** **** **** ${currentClient.cardNumber} / ${currentClient.cardExpiry}`;
        
        showPage('clientProfile');
    }
    
    // Fonction d'analyse pour l'Admin
    function analyzeCreditEligibility() {
        if (!currentClient) {
            document.getElementById('eligibilityStatus').innerHTML = "Veuillez sélectionner un client pour commencer l'analyse.";
            document.getElementById('recommendationsSection').style.display = 'none';
            return;
        }
        
        document.getElementById('analyzedClientName').textContent = `${currentClient.firstName} ${currentClient.lastName}`;
            document.getElementById('eligibilityStatus').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Analyse IA en cours...';
        document.getElementById('eligibilityDetails').style.display = 'none';
        document.getElementById('recommendationsSection').style.display = 'none';
        
        setTimeout(() => {
            const score = currentClient.creditScore;
            const endebtment = currentClient.endebtmentRatio;
            let eligibility = '';
            let details = '';
            let recommendations = [];
            
            if (score >= 8.0 && endebtment <= 0.30) {
                // ÉLIGIBLE (Ex: Didier Fouda)
                eligibility = `<span style="color: var(--success); font-weight: 700;">✓ ÉLIGIBLE - TAUX PRÉFÉRENTIEL DISPONIBLE</span>`;
                details = `<i class="fas fa-info-circle"></i> Le client présente un profil exceptionnel (Score: ${score}/10, Endettement: ${Math.round(endebtment * 100)}%).`;
                recommendations = [
                    "Aucune action nécessaire. Le dossier est prioritaire.",
                    "Taux préférentiel applicable : 5.9% (simulation).",
                    "Capacité d'emprunt maximale : 10 000 000 FCFA (simulation)."
                ];
            } else if (score >= 6.5 && endebtment <= 0.45) {
                 // À SURVEILLER (Ex: Clarisse Mbia)
                eligibility = `<span style="color: var(--warning); font-weight: 700;">⚠ ÉLIGIBILITÉ CONDITIONNELLE</span>`;
                details = `<i class="fas fa-exclamation-triangle"></i> Le client a un bon profil (Score: ${score}/10, Endettement: ${Math.round(endebtment * 100)}%). Le taux d'endettement est à la limite.`;
                recommendations = [
                    "**Augmenter l'apport personnel** à 30% du montant demandé pour réduire le risque.",
                    "Fournir un historique bancaire complet des 12 derniers mois.",
                    "Recommandation : Réduire les petites dettes avant l'approbation."
                ];
            } else {
                 // RISQUE ÉLEVÉ (Ex: Paul Ngono)
                eligibility = `<span style="color: var(--danger); font-weight: 700;">✗ NON ÉLIGIBLE ACTUELLEMENT</span>`;
                details = `<i class="fas fa-times-circle"></i> Le score de crédit est faible (${score}/10) et le taux d'endettement est trop élevé (${Math.round(endebtment * 100)}%).`;
                recommendations = [
                    "**Réduire le taux d'endettement** : Rembourser au moins 50% des crédits à la consommation existants.",
                    "**Stabiliser l'épargne** : Déposer 100 000 FCFA par mois pendant 6 mois sans retrait.",
                    "Fournir un justificatif de stabilité d'emploi d'au moins 2 ans."
                ];
            }
            
            document.getElementById('eligibilityStatus').innerHTML = eligibility;
            document.getElementById('eligibilityDetails').innerHTML = details;
            document.getElementById('eligibilityDetails').style.display = 'block';

            const recommendationsList = document.getElementById('recommendationsList');
            recommendationsList.innerHTML = '';
            recommendations.forEach(rec => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="fas fa-lightbulb" style="color: var(--primary);"></i> ${rec}`;
                recommendationsList.appendChild(li);
            });
            document.getElementById('recommendationsSection').style.display = 'block';

        }, 1500); // Délai de simulation
    }

    async function updateCreditRequestStatus(status) {
        let targetRequestId = currentRequestId;

        // Si aucune demande sélectionnée, prendre la première demande en attente (éventuellement pour le client courant)
        if (!targetRequestId) {
            let candidate = null;
            if (currentClient) {
                candidate = pendingCreditRequests.find(r => r.clientId === currentClient.id && r.status === 'pending');
            }
            if (!candidate) {
                candidate = pendingCreditRequests.find(r => r.status === 'pending');
            }
            if (!candidate) {
                // Aucune demande à traiter, on ne fait rien
                return;
            }
            targetRequestId = candidate.id;
            currentRequestId = candidate.id;
            if (!currentClient) {
                const c = clientsData.find(c => c.id === candidate.clientId);
                if (c) {
                    currentClient = c;
                }
            }
        }

        try {
            const response = await fetch(`/api/admin/credit-requests/${targetRequestId}/status`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status })
            });
            const data = await response.json();
            if (!response.ok) {
                console.error('Erreur mise à jour statut crédit:', data);
                return;
            }
            // Rafraîchir la liste et l'analyse
            await loadPendingRequests(currentClient ? currentClient.id : null);
            if (currentClient) {
                analyzeCreditEligibility();
            }
        } catch (error) {
            console.error('Erreur update statut crédit:', error);
        }
    }

    async function loadPendingRequests(filterClientId = null) {
        const list = document.getElementById('pendingRequestsList');
        list.innerHTML = '<li class="p-3 text-center text-muted">Chargement...</li>';
        currentRequestId = null;

        try {
            const url = filterClientId ? `/api/admin/credit-requests?client_id=${filterClientId}` : '/api/admin/credit-requests';
            const response = await fetch(url);
            const data = await response.json();
            if (!response.ok) {
                list.innerHTML = `<li class="p-3 text-center text-danger">Erreur: ${data.error || 'chargement'}</li>`;
                return;
            }

            pendingCreditRequests = data.requests || [];
            document.getElementById('pendingRequestCount').textContent = pendingCreditRequests.length;

            if (pendingCreditRequests.length === 0) {
                list.innerHTML = '<li class="p-3 text-center text-muted">Aucune demande de crédit.</li>';
                return;
            }

            list.innerHTML = '';
            pendingCreditRequests.forEach(req => {
                const client = clientsData.find(c => c.id === req.clientId);
                const displayName = req.clientName || (client ? `${client.firstName} ${client.lastName}` : `Client ${req.clientId}`);
                const statusBadge = req.status === 'approved' ? 'bg-success' : req.status === 'rejected' ? 'bg-secondary' : 'bg-warning text-dark';
                const statusLabel = req.status === 'approved' ? 'Approuvée' : req.status === 'rejected' ? 'Rejetée' : 'En attente';

                const item = document.createElement('li');
                item.className = 'pending-item card-body';
                item.onclick = () => { 
                    if (client) {
                        currentClient = client;
                        viewClientProfile(req.clientId); 
                    }
                    currentRequestId = req.id;
                    document.getElementById('analyzedClientName').textContent = displayName;
                    analyzeCreditEligibility();
                    showPage('creditPrediction');
                };
                
                item.innerHTML = `
                    <div>
                        <strong class="me-2">${displayName}</strong>
                        <span class="pending-item-tag">${formatFCFA(req.amount)}</span>
                        <small class="text-muted d-block">${req.purpose} - ${req.duration} mois</small>
                        <span class="badge ${statusBadge} mt-1">${statusLabel}</span>
                    </div>
                    <div class="text-end">
                        <small class="text-muted">${formatDate(req.created_at)}</small>
                        <i class="fas fa-chevron-right ms-2 text-primary"></i>
                    </div>
                `;
                list.appendChild(item);
            });
        } catch (error) {
            console.error('Erreur chargement demandes crédit:', error);
            list.innerHTML = '<li class="p-3 text-center text-danger">Erreur réseau</li>';
        }
    }

    // ========== FONCTIONS CLIENT ==========
    function showClientPage(pageId) {
        document.querySelectorAll('#clientInterface .page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active'); 
        
        document.querySelectorAll('#clientSidebar .nav-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`#clientSidebar a[onclick="showClientPage('${pageId}')"]`).classList.add('active');
        
        if (pageId === 'clientDashboard') {
            setTimeout(() => { 
                initClientChart(); 
                initCategoryAveragesChart();
            }, 300);
        }
    }
    
    // Soumission de la demande de crédit
    async function submitCreditRequest(event) {
        event.preventDefault();
        
        const amount = document.getElementById('loanAmount').value;
        const duration = document.getElementById('loanDuration').value;
        const purpose = document.getElementById('loanPurpose').value;

        if (!amount || !duration || !purpose) {
            showErrorAlert('Formulaire incomplet', 'Veuillez remplir tous les champs du formulaire de crédit.');
            return;
        }

        const numericAmount = parseFloat(amount);
        const numericDuration = parseInt(duration, 10);

        if (isNaN(numericAmount) || numericAmount <= 0) {
            showErrorAlert('Montant invalide', 'Le montant du crédit doit être un nombre positif.');
            return;
        }

        if (isNaN(numericDuration) || numericDuration <= 0) {
            showErrorAlert('Durée invalide', 'La durée du crédit doit être un nombre de mois positif.');
            return;
        }

        try {
            const response = await fetch('/api/credit-request', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: numericAmount,
                    duration: numericDuration,
                    purpose: purpose
                })
            });

            const data = await response.json();

            if (!response.ok) {
                showErrorAlert('Soumission échouée', data.error || 'Erreur lors de la soumission de la demande.');
                return;
            }

            // Store for AI chat context
            creditRequestData = {
                amount: numericAmount,
                duration: numericDuration,
                purpose: purpose
            };

            // Add to pending requests list (for admin view)
            pendingCreditRequests.push({
                id: pendingCreditRequests.length + 101,
                clientId: currentUser.id,
                clientName: `${currentUser.firstName} ${currentUser.lastName}`,
                date: new Date().toLocaleDateString('fr-FR'),
                amount: numericAmount,
                duration: numericDuration,
                purpose: purpose
            });

            showSuccessAlert(
                'Demande soumise',
                `Votre demande de ${formatFCFA(numericAmount)} a été transmise à notre équipe d'analyse crédit. Un administrateur l'examinera bientôt.`
            );
            
            // Vider le formulaire et rediriger vers le dashboard
            document.getElementById('creditRequestForm').reset();
            showClientPage('clientDashboard');
        } catch (error) {
            console.error('Error submitting credit request:', error);
            showErrorAlert('Erreur', 'Erreur lors de la soumission. Veuillez réessayer.');
        }
    }

    async function initClientChart() {
        const ctx = document.getElementById('clientComparisonChart');
        if (!ctx) return;
        if (chartInstances.clientComparisonChart) {
            chartInstances.clientComparisonChart.destroy();
        }

        // Fetch monthly data from backend
        try {
            const clientId = currentUser ? currentUser.id : null;
            const url = `/api/transactions/monthly${clientId ? `?client_id=${clientId}` : ''}`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (!result.data || result.data.length === 0) {
                // Fallback to empty chart if no data
                chartInstances.clientComparisonChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'top' },
                            title: { display: true, text: 'Aucune donnée disponible' }
                        }
                    }
                });
                return;
            }

            const monthlyData = result.data;
            const labels = monthlyData.map(d => d.label);
            const incomeData = monthlyData.map(d => Math.abs(d.income) / 1000); // Convert to thousands
            const expenseData = monthlyData.map(d => d.expense / 1000); // Convert to thousands
            
            chartInstances.clientComparisonChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenus (K FCFA)',
                        data: incomeData,
                        backgroundColor: 'rgba(0, 200, 83, 0.6)',
                        borderColor: 'rgba(0, 200, 83, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Dépenses (K FCFA)',
                        data: expenseData,
                        backgroundColor: 'rgba(230, 0, 40, 0.6)',
                        borderColor: 'rgba(230, 0, 40, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'top', labels: { usePointStyle: true } },
                        tooltip: { 
                            callbacks: { 
                                label: (context) => {
                                    const value = Math.abs(context.parsed.y);
                                    return context.dataset.label + ': ' + value.toFixed(1) + 'K FCFA';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Montant (Kilo FCFA)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error fetching monthly data:', error);
            // Show error message on chart
            ctx.getContext('2d').fillText('Erreur de chargement des données', 10, 50);
        }
    }

    async function initCategoryAveragesChart() {
        const ctx = document.getElementById('categoryAveragesChart');
        if (!ctx) return;
        if (chartInstances.categoryAveragesChart) {
            chartInstances.categoryAveragesChart.destroy();
        }

        // Fetch category averages from backend
        try {
            const clientId = currentUser ? currentUser.id : null;
            const url = `/api/transactions/category-averages${clientId ? `?client_id=${clientId}` : ''}`;
            const response = await fetch(url);
            const result = await response.json();
            
            if (!result.data || result.data.length === 0) {
                chartInstances.categoryAveragesChart = new Chart(ctx.getContext('2d'), {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            title: { display: true, text: 'Aucune donnée disponible' }
                        }
                    }
                });
                return;
            }

            const categoryData = result.data;
            const labels = categoryData.map(d => d.category);
            const averages = categoryData.map(d => Math.abs(d.average) / 1000); // Convert to thousands
            
            // Color palette
            const colors = [
                'rgba(230, 0, 40, 0.6)',   // Red
                'rgba(255, 152, 0, 0.6)',  // Orange
                'rgba(0, 200, 83, 0.6)',   // Green
                'rgba(0, 0, 0, 0.6)',      // Black
                'rgba(13, 71, 161, 0.6)',  // Blue
                'rgba(156, 39, 176, 0.6)', // Purple
                'rgba(244, 67, 54, 0.6)',  // Red variant
            ];
            
            chartInstances.categoryAveragesChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Moyenne (K FCFA)',
                        data: averages,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                        borderColor: labels.map((_, i) => colors[i % colors.length].replace('0.6', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { display: false },
                        tooltip: { 
                            callbacks: { 
                                label: (context) => {
                                    const value = Math.abs(context.parsed.y);
                                    return 'Moyenne: ' + value.toFixed(1) + 'K FCFA';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            title: { display: true, text: 'Montant Moyen (Kilo FCFA)' }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error fetching category averages:', error);
        }
    }

    async function initAdminChart() {
        if (chartInstances.adminClientBalanceChart) chartInstances.adminClientBalanceChart.destroy();
        if (chartInstances.adminClientExpenseChart) chartInstances.adminClientExpenseChart.destroy();

        if (!currentClient) return;

        const clientId = currentClient.id;

        // Solde des comptes (évolution mensuelle approximative)
        const balanceCtx = document.getElementById('adminClientBalanceChart').getContext('2d');
        try {
            const url = `/api/transactions/monthly?client_id=${clientId}`;
            const response = await fetch(url);
            const result = await response.json();

            const monthlyData = (result.data || []).sort((a, b) => a.year - b.year || a.month - b.month);
            const labels = [];
            const balances = [];

            let balance = currentClient.currentBalance || 0;
            // Recalculer le solde en remontant dans le temps (approximation)
            // On part du solde initial et on applique les flux dans l'ordre chronologique
            balance = currentClient.currentBalance || 0;
            let cumulative = balance;
            // Reviens en arrière en soustrayant les flux (ordre inverse)
            for (let i = monthlyData.length - 1; i >= 0; i--) {
                cumulative -= monthlyData[i].net || 0;
            }
            balance = cumulative;

            monthlyData.forEach((m) => {
                balance += m.net || 0;
                labels.push(m.label);
                balances.push(Math.max(0, balance / 1_000_000)); // en millions
            });

            chartInstances.adminClientBalanceChart = new Chart(balanceCtx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Solde Compte Principal',
                        data: balances,
                        borderColor: 'var(--primary)',
                        backgroundColor: 'var(--primary-light)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true, position: 'top' } },
                    scales: { y: { title: { display: true, text: 'Solde (Millions FCFA)' } } }
                }
            });
        } catch (error) {
            console.error('Error fetching admin balance data:', error);
        }

        // Distribution des dépenses par catégorie (annuelle)
        const expenseCtx = document.getElementById('adminClientExpenseChart').getContext('2d');
        try {
            const url = `/api/transactions/category-averages?client_id=${clientId}`;
            const response = await fetch(url);
            const result = await response.json();

            const categoryData = result.data || [];
            const labels = categoryData.map(d => d.category);
            const values = categoryData.map(d => Math.abs(d.average));

            chartInstances.adminClientExpenseChart = new Chart(expenseCtx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#E60028', '#FF9800', '#00C853', '#000000', '#0D47A1', '#8E24AA', '#26C6DA'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        } catch (error) {
            console.error('Error fetching admin expense data:', error);
        }
    }

    function toggleChatbot() {
        const window = document.getElementById('chatbotWindow');
        const icon = document.getElementById('chatbotIcon');
        
        const isClientInterface = document.getElementById('clientInterface').classList.contains('active');
        if (!isClientInterface) {
            showInfoAlert(
                "Assistant indisponible",
                "L'assistant IA n'est disponible que dans l'Espace Client."
            );
            return;
        }

        if (window.style.display === 'block') {
            window.style.display = 'none';
            icon.className = 'fas fa-comments';
        } else {
            window.style.display = 'block';
            icon.className = 'fas fa-times';
        }
    }
    
    async function sendChatbotMessage() {
        const input = document.getElementById('chatbotInput');
        const messages = document.getElementById('chatMessages');
        const userMessage = input.value.trim();

        if (userMessage === '') return;

        const userDiv = document.createElement('div');
        userDiv.className = 'message-user';
        userDiv.innerHTML = `<small><strong>Vous:</strong> ${userMessage}</small>`;
        messages.appendChild(userDiv);

        // Mettre à jour l'historique (utilisateur)
        chatHistory.push({ type: 'user', text: userMessage });
        saveChatHistory();

        input.value = '';
        messages.scrollTop = messages.scrollHeight;

        // Show loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'message-bot';
        loadingDiv.innerHTML = `<small><i class="fas fa-spinner fa-spin"></i> Analyse en cours...</small>`;
        messages.appendChild(loadingDiv);
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/chat/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: userMessage,
                    creditAmount: creditRequestData.amount,
                    creditDuration: creditRequestData.duration
                })
            });

            const data = await response.json();

            // Remove loading indicator
            loadingDiv.remove();

            if (!response.ok) {
                throw new Error(data.error || 'Erreur de communication');
            }

            const botMessage = document.createElement('div');
            botMessage.className = 'message-bot';
            botMessage.innerHTML = `<small><strong>Assistant GC:</strong> ${data.response}</small>`;
            messages.appendChild(botMessage);

            // Mettre à jour l'historique (bot)
            chatHistory.push({ type: 'bot', text: data.response });
            saveChatHistory();
            messages.scrollTop = messages.scrollHeight;
        } catch (error) {
            console.error('Chat error:', error);
            loadingDiv.remove();
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message-bot';
            const errorText = "Désolé, une erreur s'est produite. Veuillez réessayer.";
            errorMessage.innerHTML = `<small><strong>Assistant GC:</strong> ${errorText}</small>`;
            messages.appendChild(errorMessage);

            // Enregistrer le message d'erreur dans l'historique
            chatHistory.push({ type: 'bot', text: errorText });
            saveChatHistory();
            messages.scrollTop = messages.scrollHeight;
        }
    }
    

    // ========== INITIALISATION ==========
    document.addEventListener('DOMContentLoaded', function() {
        showLoginForm('client');
        
        // Check if user is already logged in
        loadCurrentUser();
        
        const chatbotInput = document.getElementById('chatbotInput');
        if (chatbotInput) {
            chatbotInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendChatbotMessage();
                }
            });
        }
        
        // Aucun client sélectionné par défaut côté admin avant chargement depuis le backend
        currentClient = null;
    });
</script>

</body>
</html>